<html>
<head>
<title>Line</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 

<script type="application/javascript" src="js/jquery-1.6.2.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
		<script type="text/javascript" src="js/jquery-timer-1.0.0.js"></script>

<script type="application/javascript" src="interpreter/lexer.js"></script>
<script type="application/javascript" src="interpreter/listparser.js"></script>
<script type="application/javascript" src="interpreter/parser.js"></script>
<script type="application/javascript" src="interpreter/langlib.js"></script>
<script type="application/javascript" src="interpreter/eval.js"></script>
<script type="application/javascript" src="interpreter/util.js"></script>



<script type="text/javascript" src="js/bonobonovector.js"></script>
<script type="text/javascript" src="js/motion.js"></script>

<script type="text/javascript">

function showSelectionDialog(content, callback, data) {
	$('#userInputDialog').dialog({
		autoOpen: true,
		show: "blind",
		hide: "blind",
		resizable: false,
		draggable: false,
		width: 400,
		open: (function() {
			$('#userInputDialog')[0].innerHTML = '<p>' + content + '</p>';
			console.log(data);
			for (var i in data) {
				var button = document.createElement('button');
				button.innerText = data[i];
				button.id = "button" + data[i];
				$('#userInputDialog')[0].appendChild(button);
				$('#button' + data[i]).button().click(function() {

							$('#userInputDialog').dialog('close');
							$('#userInputDialog').dialog('destroy');
							callback(data[i]);
						});
				$('#button' + data[i]).css('width', 375);
			}
		})
	});
}

	var g_interp = new Interp();
	var g_state;
	register_funcs(g_interp, motion);

	var global = this;
	var funcs = {
		'alert': alert,
		'prompt': function(msg) {
			return prompt(msg);
		},
		'setv': function(name, value) {
			var code = name + ' = ' + JSON.stringify(value) + ';';
			eval(code);
		}
	};
	register_funcs(g_interp, funcs);

	var g_suspended = {};
	g_interp.global_env['wait_event'] = native_func(function(interp, args, state) {
		g_suspended[args[0]] = state;
	});

	
	g_interp.global_env['choice'] = native_func(function(interp, args, state) {
		alert("aa");
		var callback = (function(name, args, state) {
			return function(selected) { state.do_return(selected); }
		})(args[0], args.slice(1), state);
		showSelectionDialog(args[0],callback,args.slice(1));
	});

	var return_event = function(name, retv) {
		var s = g_suspended[name];
		g_suspended[name] = null;
		s.do_return(retv);
	}
	g_interp.global_env['test'] = g_interp.eval(parse('(lambda () (alert "test"))'))

</script>

</head>
<body>
	<div id="Canvas Ex" style="float: left">
		<canvas id="screen" width="600" height="800">
		</canvas>
	</div>
				<div id="userInputDialog" title="input">
			</div>
	<div id="sound" >
		<audio id = "vocal" controls autoplay style="display: none;" name="media" src="http://sapzil.sigkill.kr/tts/tts_synth_api.php?w=tts&lang=ko&text=보노"></audio>

		<audio id = "sweat" controls autoplay style="display: none;" name="media" src="data/sweat.mp3"></audio>

	</div>
	<div id="content">
		<script type="text/javascript">
			init_data();
			
			face_shake_speed = 0;
			face_shake_A = 15;
			body_shake_speed = 0;
			body_shake_A = 15;
			body_arm_speed = 0.5;
			body_arm_A = 30;
			
			face_sweat_len = 3;
			
			face_eye_state = 1;
			
			face_red = 0;
			
			face_mouse_speed = 0;
			
			body_walk_dir = 2;
			
			setInterval(draw_front,time_interval);
			
		</script>
	</div>
	<textarea id="code" style="float:right; width: 40em; height: 50em;"></textarea>
	<textarea id="logbono" style="float:bottom; height: 40em;"></textarea>
	<input type="button" value="보기" id="btn" />
	<input type="button" id="faster" value="" />
	<input type="button" id="slower" value=""/>

	<script type="text/javascript">
		function run() {
			var inp = $('#code').val();
			var t = parse(inp);
			var res = g_interp.eval(t);
			//alert('eval finished: ' + res);
		}
		function logmsg(msg) {
			$('#logbono').val($('#logbono').val() + msg + '\n');
		}
		g_interp.global_env['logmsg'] = native_func(function(interp, args) {
			logmsg(args[0]);
		});


		$('#btn').click(run);
		$('#code').keypress(function(e) {
			if (e.which == 13) {
				run();
			}
		});

		$('#faster').click(function() {
			return_event('speed', 'fast');
		});
		$('#slower').click(function() {
			return_event('speed', 'slow');
		});

	</script>

</body>
</html>
